# README - ansible-setup

Ansible is used to simplify IT automation.  An Ansible Control Machine is 
configured to connect to other managed devices and automate various tasks.

This repository is meant to boot strap the installation and configuration of an 
ACM on a local host.  These instructions are adapted from the official 
Ansible [Installation Guide](https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html).

After installation, the ACM can manage tasks on inventoried devices by connecting
to them (typically over SSH) and performing tasks.  In order to achieve this, 
the ACM needs a way to run privileged and unprivileged commands as necessary.

To ease integration and provided auditability, the ACM and inventoried hosts 
should have an additional _ansible-user_ account created that all ansible tasks 
should be run as and should have the ability to perform all tasks necessary, with 
little to no user input.

The _ansible-user_ can simply be the _root_ user, however this does not provide 
the auditability that may be required.

## Installation 

### Summary

1. Clone this repository.
2. Run `setup-scripts/setup.sh` as a user that can elevate privileges. (herein 
   known as _setup-user_)
3. Run `setup-scripts/setup-new-inventory.sh` to generate a default directory 
   structure and populate it with a `localhost` object.
4. Create password hashes for the _setup-user_ and _ansible-user_ accounts.

```bash
git clone https://github.com/mfallone/ansible-setup.git ./ansible
cd ansible
./setup-scripts/setup.sh
./setup-scripts/setup-new-inventory.sh
# See README - Next Steps
```

### Detailed Steps

Clone this repository into a new root andible path and run `setup-scripts/setup.sh` 
as a user with elevated privileges.

`setup.sh` calls `install-ansible.sh` as an elevated user to:

* Install the Debian/Ubuntu Ansible PPA
* Install Ansible through `apt`

`setup.sh` will then create the default paths, which can be overidden or 
changed later:

* Create Ansible inventory (`ANSIBLE_INVENTORY`) and role (`ANSIBLE_ROLE`) paths
* Generate a local config (`./ansible.cfg`) file if it doesn't already exist.

For additional setup steps, add the [ansible-role-control-machine](https://github.com/mfallone/ansible-role-control-machine) 
role, check the configuration and run `example-playbook.yaml`.

## Inventory

A helper script [`setup-new-inventory.sh`](./setup-scripts/setup-new-inventory.sh) 
is provided and should be run on newly created control machines.  The script will

* Create new `production` and `testing` inventory directories (which can be 
  overridden). 
  with `group_vars`, `host_vars` and `vars` files/folders.
* Create a new `localhost` directory with `vars` and `vault` files.
* Populate `vars` fiile with reasonable default values (i.e. `setup-user`).

## Next Steps 

After the inventory is created a playbook must be run to finish configuration of
the Ansible Control Machine.  This playbook is intended to be run by the same
user that cloned and ran the setup script.  The final configuration steps include: 

* Create a new ansible user and group
* Create a ssh_key for the ansible user
* Grant elevated permissions to new account
* Change ownership of the ansible directory to the new account.

Some prerequisites are required to be manually input prior to running this playbook.

* `vault_new_user_password` : The newly created ansible user password.  Required.
* `vault_setup_ssh_password`: The initial user account that runs the inital playbook.

The password hashes can be generated by running the following python command and 
entering in the plaintext password:

```bash
NEW_USER_PASSWORD_HASH=$(python3 -c 'import crypt,getpass; print(crypt.crypt(getpass.getpass(), crypt.mksalt(crypt.METHOD_SHA512)))')
SETUP_SSH_PASSWORD_HASH=$(python3 -c 'import crypt,getpass; print(crypt.crypt(getpass.getpass(), crypt.mksalt(crypt.METHOD_SHA512)))')
```

Generate a hash for the listed password prerequisities and put the key-value pairs
into a variable file to be encrypted using `ansible-vault`:

```bash
echo "
vault_new_user_password: \"${NEW_USER_PASSWORD_HASH}\"
vault_setup_ssh_password: \"${SETUP_SSH_PASSWORD_HASH}\"
" > ./inventory/production/host_vars/localhost/vault
```

Encrypt the `vault` file and enter in a master Ansible Vault password (required
later to decrypt values).

```bash
ansible-vault encrypt ./inventory/production/host_vars/localhost/vault
```

Once the preceding steps are complete run the `example-playbook.yaml` file to
complete setting up the Ansible Control Machine.

```bash
ansible-playbook example-playbook.yaml --ask-vault-pass
```
